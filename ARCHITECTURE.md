# LovPen æ¶æ„æ–‡æ¡£

## æ¶æ„ç†å¿µï¼šFrontend (React) + Platform (Obsidian/Web) åˆ†ç¦»

ç±»ä¼¼äº **Tauri + React** çš„æ¶æ„æ¨¡å¼ï¼š
- `packages/frontend/` = **çº¯ UI å±‚**ï¼ˆç±»ä¼¼ Tauri çš„ Web å‰ç«¯ï¼‰
- `packages/obsidian/` = **Obsidian å¹³å°é€‚é…å±‚**ï¼ˆç±»ä¼¼ Tauri çš„ Rust åç«¯ï¼‰
- `packages/shared/` = **å…±äº«å·¥å…·åº“**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    packages/frontend                     â”‚
â”‚                       (çº¯ UI å±‚)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  React Components (å¹³å°æ— å…³)                    â”‚   â”‚
â”‚  â”‚  - LovpenReact.tsx                              â”‚   â”‚
â”‚  â”‚  - Toolbar, ArticleRenderer, etc.               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Design System (ç»Ÿä¸€è®¾è®¡ç³»ç»Ÿ)                   â”‚   â”‚
â”‚  â”‚  - index.css (CSS å˜é‡ + TailwindCSS)          â”‚   â”‚
â”‚  â”‚  - æ”¯æŒ Obsidian å’Œ Web ä¸¤ç§ç¯å¢ƒ               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Platform Adapters (å¹³å°é€‚é…å™¨æ¥å£)             â”‚   â”‚
â”‚  â”‚  - web-adapter.ts                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Build Output (IIFE æ„å»ºäº§ç‰©)                   â”‚   â”‚
â”‚  â”‚  - dist/lovpen-react.iife.js                    â”‚   â”‚
â”‚  â”‚  - dist/style.css                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ (é€šè¿‡ IIFE åŠ è½½)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               packages/obsidian                          â”‚
â”‚              (Obsidian å¹³å°é€‚é…å±‚)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Platform Integration                            â”‚   â”‚
â”‚  â”‚  - note-preview-external.tsx                     â”‚   â”‚
â”‚  â”‚  - åŠ è½½ frontend IIFE åŒ…                         â”‚   â”‚
â”‚  â”‚  - æ·»åŠ  .lovpen-obsidian-env ç±»                 â”‚   â”‚
â”‚  â”‚  - æä¾› Obsidian API ç»‘å®š                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Obsidian Specific Logic                        â”‚   â”‚
â”‚  â”‚  - Markdown å¤„ç†                                 â”‚   â”‚
â”‚  â”‚  - æ’ä»¶ç³»ç»Ÿ                                      â”‚   â”‚
â”‚  â”‚  - æ¨¡æ¿å¼•æ“                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒè®¾è®¡ï¼šç»Ÿä¸€çš„ CSS å˜é‡ç³»ç»Ÿ

### é—®é¢˜
- Frontend ä½¿ç”¨ TailwindCSS å˜é‡ (`--background`, `--foreground`, etc.)
- Obsidian ä½¿ç”¨åŸç”Ÿå˜é‡ (`--background-primary`, `--text-normal`, etc.)
- ä¸¤å¥—å˜é‡ç³»ç»Ÿå¯¼è‡´ UI å‘ˆç°ä¸ä¸€è‡´

### è§£å†³æ–¹æ¡ˆï¼šCSS å˜é‡æ˜ å°„å±‚

#### 1. é»˜è®¤ä¸»é¢˜ï¼ˆWeb ç¯å¢ƒï¼‰
```css
/* packages/frontend/src/index.css */
:root {
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --border: oklch(0.922 0 0);
  /* ... å…¶ä»– TailwindCSS å˜é‡ */
}
```

#### 2. Obsidian ç¯å¢ƒé€‚é…
```css
/* packages/frontend/src/index.css */
.lovpen-obsidian-env {
  /* å°† Obsidian å˜é‡æ˜ å°„åˆ°æˆ‘ä»¬çš„è®¾è®¡ç³»ç»Ÿ */
  --background: var(--background-primary, oklch(1 0 0));
  --foreground: var(--text-normal, oklch(0.145 0 0));
  --border: var(--background-modifier-border, oklch(0.922 0 0));
  --primary: var(--interactive-accent, oklch(0.205 0 0));
  /* ... å®Œæ•´æ˜ å°„ */
}
```

#### 3. Obsidian å¹³å°é€‚é…å±‚
```typescript
// packages/obsidian/note-preview-external.tsx
async buildUI() {
  this.reactContainer = document.createElement('div');

  // ğŸ”‘ å…³é”®ï¼šæ·»åŠ  Obsidian ç¯å¢ƒç±»ï¼Œå¯ç”¨ CSS å˜é‡æ˜ å°„
  this.reactContainer.classList.add('lovpen-obsidian-env');

  this.container.appendChild(this.reactContainer);
  await this.updateExternalReactComponent();
}
```

## æ ·å¼ç»Ÿä¸€åŸåˆ™

### âœ… æ­£ç¡®åšæ³•
1. **æ‰€æœ‰åŸºç¡€æ ·å¼å®šä¹‰åœ¨ `packages/frontend/src/index.css`**
2. **ç»„ä»¶å†…ä¸ç¡¬ç¼–ç æ ·å¼**ï¼ˆç§»é™¤äº† `dangerouslySetInnerHTML` çš„å†…è”æ ·å¼ï¼‰
3. **ä½¿ç”¨ CSS å˜é‡è€Œéç¡¬ç¼–ç é¢œè‰²å€¼**
4. **é€šè¿‡ CSS ç±»æ§åˆ¶ç¯å¢ƒå·®å¼‚**ï¼ˆ`.lovpen-obsidian-env`ï¼‰

### âŒ é¿å…çš„åšæ³•
1. ~~åœ¨ç»„ä»¶å†…ç¡¬ç¼–ç  `<style dangerouslySetInnerHTML />`~~
2. ~~ç›´æ¥ä½¿ç”¨ Obsidian çš„ CSS å˜é‡~~
3. ~~åœ¨ä¸åŒç¯å¢ƒé‡å¤å®šä¹‰ç›¸åŒæ ·å¼~~

## æ„å»ºæµç¨‹

### Frontend æ„å»ºï¼ˆViteï¼‰
```bash
cd packages/frontend
pnpm build
# è¾“å‡º:
# - dist/lovpen-react.iife.js  (IIFE æ ¼å¼çš„ React ç»„ä»¶)
# - dist/style.css             (åŒ…å«æ‰€æœ‰æ ·å¼ï¼Œå«ç¯å¢ƒé€‚é…)
```

### Obsidian æ„å»ºï¼ˆesbuildï¼‰
```bash
cd packages/obsidian
pnpm build
# è‡ªåŠ¨æ‰§è¡Œ:
# 1. æ„å»º TypeScript ä»£ç 
# 2. å¤åˆ¶ frontend/dist/** åˆ° dist/frontend/
# 3. å¤åˆ¶åˆ° Obsidian æ’ä»¶ç›®å½•ï¼ˆå¦‚æœé…ç½®äº† OBSIDIAN_PLUGIN_PATHï¼‰
```

## CSS å˜é‡æ˜ å°„è¡¨

| è®¾è®¡ä»¤ç‰Œ | Web é»˜è®¤å€¼ | Obsidian æ˜ å°„ |
|---------|-----------|--------------|
| `--background` | `oklch(1 0 0)` | `var(--background-primary)` |
| `--foreground` | `oklch(0.145 0 0)` | `var(--text-normal)` |
| `--border` | `oklch(0.922 0 0)` | `var(--background-modifier-border)` |
| `--primary` | `oklch(0.205 0 0)` | `var(--interactive-accent)` |
| `--muted-foreground` | `oklch(0.556 0 0)` | `var(--text-muted)` |
| `--destructive` | `oklch(0.577 0.245 27.325)` | `var(--text-error)` |

å®Œæ•´æ˜ å°„è§ `packages/frontend/src/index.css` ä¸­çš„ `.lovpen-obsidian-env` ç±»ã€‚

## å¼€å‘å·¥ä½œæµ

### Web å¼€å‘ï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰
```bash
pnpm dev:web
# è®¿é—® http://localhost:1101
# ä½¿ç”¨ Web é€‚é…å™¨ (web-adapter.ts)
# æ ·å¼ä½¿ç”¨ :root çš„é»˜è®¤å€¼
```

### Obsidian å¼€å‘ï¼ˆHMR æ¨¡å¼ï¼‰
```bash
# ç»ˆç«¯ 1: å¯åŠ¨ Frontend HMR
cd packages/frontend && pnpm dev

# ç»ˆç«¯ 2: å¯åŠ¨ Obsidian ç›‘å¬
cd packages/obsidian && pnpm dev

# Obsidian æ’ä»¶ä¼šè‡ªåŠ¨ä» http://localhost:5173 åŠ è½½ HMR ç‰ˆæœ¬
# æ ·å¼é€šè¿‡ .lovpen-obsidian-env é€‚é… Obsidian ç¯å¢ƒ
```

## æœªæ¥æ‰©å±•

### æ–°å¢å¹³å°æ”¯æŒ
å¦‚éœ€æ”¯æŒæ–°å¹³å°ï¼ˆå¦‚ VSCode æ’ä»¶ï¼‰ï¼Œåªéœ€ï¼š
1. åˆ›å»ºæ–°çš„ CSS å˜é‡æ˜ å°„ç±»ï¼ˆå¦‚ `.lovpen-vscode-env`ï¼‰
2. åœ¨å¹³å°é€‚é…å±‚æ·»åŠ è¯¥ç±»
3. æ— éœ€ä¿®æ”¹ Frontend ç»„ä»¶ä»£ç 

### ç¤ºä¾‹ï¼šVSCode é€‚é…
```css
/* packages/frontend/src/index.css */
.lovpen-vscode-env {
  --background: var(--vscode-editor-background);
  --foreground: var(--vscode-editor-foreground);
  --border: var(--vscode-panel-border);
  /* ... */
}
```

```typescript
// packages/vscode/extension.ts
const webview = vscode.window.createWebviewPanel(...);
webview.webview.html = `
  <div class="lovpen-vscode-env" id="root"></div>
  <script src="${reactLibUri}"></script>
`;
```

## å…³é”®ä¼˜åŠ¿

1. **ğŸ¨ æ ·å¼ä¸€è‡´æ€§**ï¼šæ‰€æœ‰ç¯å¢ƒå…±äº«åŒä¸€å¥—è®¾è®¡ç³»ç»Ÿ
2. **ğŸ”§ æ˜“äºç»´æŠ¤**ï¼šæ ·å¼å®šä¹‰åœ¨ä¸€ä¸ªåœ°æ–¹ï¼ˆ`index.css`ï¼‰
3. **ğŸš€ å¹³å°æ‰©å±•**ï¼šæ–°å¢å¹³å°åªéœ€æ·»åŠ  CSS æ˜ å°„
4. **âš¡ å¼€å‘ä½“éªŒ**ï¼šFrontend HMR + Obsidian å®æ—¶åŒæ­¥
5. **ğŸ“¦ æ„å»ºä¼˜åŒ–**ï¼šFrontend æ„å»ºä¸ºå•ä¸€ IIFE åŒ…

## æŠ€æœ¯æ ˆ

- **Frontend**: React 19 + TailwindCSS 4.x + Vite
- **Platform**: Obsidian API + esbuild
- **Design System**: CSS Variables + oklch é¢œè‰²ç©ºé—´
- **State Management**: Jotai
- **Build**: Turbo (Monorepo) + pnpm

---

**æœ€åæ›´æ–°**: 2025-11-01
**æ¶æ„ç‰ˆæœ¬**: v2.0 (Frontend-Platform Separation)
